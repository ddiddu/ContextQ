<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <base target="_top">
    <title>Letâ€™s help you prepare for your presentation.</title>
    <!-- Polyfill for custom elements (required in Apps Script iframe) -->
    <script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@2.6.0/webcomponents-bundle.js"></script>

    <!-- âœ… Use unpkg for ALL Material Web Components -->
    <script type="module" src="https://unpkg.com/@material/web/button/filled-button.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/textfield/outlined-text-field.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/select/outlined-select.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/select/select-option.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/card/outlined-card.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/button/outlined-button.js?module"></script>
    <script type="module" src="https://unpkg.com/@material/web/progress/circular-progress.js?module"></script>

    <!-- Roboto font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
      :root {
        /* ðŸŸ¦ Blue theme */
        --md-sys-color-primary: #3b82f6;            /* blue-500 */
        --md-sys-color-on-primary: #ffffff;         /* white text on blue */
        --md-sys-color-surface: #ffffff;            /* white background */
        --md-sys-color-background: #ffffff;         /* page background */
        --md-sys-color-outline: #d1d5db;            /* light gray border */
        --md-sys-color-on-surface: #111827;         /* dark text on white */
        --md-sys-color-surface-container-high: #ffffff; /* dropdown background */
      }
      body {
        font-family: Roboto, sans-serif;
        padding: 0.5rem;
      }
      md-outlined-select,
      md-outlined-text-field {
        width: 100%;
        max-width: 100%;
        margin-bottom: 16px;
      }
      md-filled-button {
        width: 100%;
        margin-top: 12px;
        border: none !important;
      }
      md-outlined-select::part(menu) {
        background-color: white !important;
      }
      .card {
        background: #ffffff;
        border-radius: 12px;
        border: 1px solid #e5e7eb; /* subtle outline */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        padding: 16px;
        margin-bottom: 20px;
        transition: box-shadow 0.2s ease;
      }

      .card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      }

      .card-header {
        font-size: 14px;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .card-body {
        font-size: 14px;
        color: #374151;
        margin-bottom: 8px;
      }

      .card-question {
        font-size: 14px;
        color: #111827;
        font-weight: 500;
        margin-bottom: 16px;
      }

      .card-actions {
        display: flex;
        gap: 8px;
      }

      #loading-indicator {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: var(--md-sys-color-surface, #ffffff);
        color: var(--md-sys-color-on-surface, #1f2937);
        border-radius: 12px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        padding: 24px 32px;
        font-size: 16px;
        font-weight: 500;
        z-index: 1000;
        text-align: center;
      }

      #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(250, 250, 250, 0.6); /* light blur look */
        z-index: 999;
        backdrop-filter: blur(2px);
      }
    </style>
  </head>
  <body>
    <!-- Context Tab -->
    <!-- <div id="context" class="tab-content active"> -->
      <!-- <div class="section"> -->
      <md-outlined-text-field
        id="presentation-purpose"
        label="Enter Your Context"
        supporting-text="e.g., Presentation Purpose, Audience"
      ></md-outlined-text-field>
      <!-- </div> -->

      <!-- Overlay for the popup -->
      <div id="popup-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeAddContextPopup()"></div>

      <md-filled-button onclick="generateQuestions()" style="margin-bottom: 20px; margin-top: -10px;">Save Context</md-filled-button>

      <md-outlined-select label="Tone" id="tone-dropdown" onchange="filterQuestionsByToneAndType()">
        <md-select-option value="very positive">Very Positive</md-select-option>
        <md-select-option value="positive">Positive</md-select-option>
        <md-select-option value="neutral">Neutral</md-select-option>
        <md-select-option value="critical">Critical</md-select-option>
        <md-select-option value="very critical">Very Critical</md-select-option>
      </md-outlined-select>

      <md-outlined-select id="type-dropdown" label="Type" onchange="filterQuestionsByToneAndType()">
        <md-select-option value="all">Both</md-select-option>
        <md-select-option value="low">Question</md-select-option>
        <md-select-option value="high">Feedback</md-select-option>
      </md-outlined-select>
      </div>
    
      <!-- Section to display filtered questions -->
      <div id="questions-display" style="margin-top: 10px;">
        <!-- Questions will be dynamically displayed here -->
      </div>
    </div>

    <div id="loading-indicator">
      <md-circular-progress indeterminate></md-circular-progress>
      <div style="margin-top: 12px;">Loading, please wait...</div>
    </div>
    <!-- </div> -->

    <script>
      // Global variable to store currently generated questions
      let currentGeneratedQuestions = [];

      // QUESTION MANAGEMENT
      function generateQuestions() {
        console.log("Generate Questions button clicked.");

        // Get the user-provided context from the input field
        const contextInput = document.getElementById('presentation-purpose').value.trim();
        if (!contextInput) {
          console.log("No context provided.");
          alert("Please enter a context before generating questions.");
          return;
        }

        console.log("User-provided context:", contextInput);

        // Prepare the context object
        const selectedContexts = [
          {
            context: contextInput,
          }
        ];

        // Show loading indicator and overlay
        const loadingIndicator = document.getElementById('loading-indicator');
        const overlay = document.createElement('div');
        overlay.id = 'loading-overlay';
        document.body.appendChild(overlay);
        loadingIndicator.style.display = 'block';
        console.log("Loading indicator displayed.");

        // Clear existing questions
        const displayDiv = document.getElementById('questions-display');
        displayDiv.innerHTML = ''; // Reset questions display

        // Call the Google Apps Script function
        google.script.run
          .withSuccessHandler(function(currentQuestions) {
            console.log("Success handler called.");
            console.log("Generated questions:", currentQuestions);

            // Hide loading indicator and remove overlay
            loadingIndicator.style.display = 'none';
            document.body.removeChild(overlay);
            console.log("Loading indicator and overlay removed.");

            // Store the generated questions in the global variable
            currentGeneratedQuestions = currentQuestions;

            // Display the newly generated questions directly below
            // displayQuestions(currentQuestions);
            displayQuestions([]);
          })
          .withFailureHandler(function(error) {
            console.log("Failure handler called.");
            console.error("Error generating questions:", error);

            // Hide loading indicator and remove overlay
            loadingIndicator.style.display = 'none';
            document.body.removeChild(overlay);
            console.log("Loading indicator and overlay removed.");

            alert("Failed to generate questions. Please try again.");
          })
          .generateComments(selectedContexts);
      }

      function saveAllQuestions(questions) {
        console.log("Saving all questions:", questions);

        const timestamp = new Date().toISOString(); // Generate a single timestamp for all personas

        // Use a Promise chain to ensure all personas are saved sequentially
        const savePromises = questions.map(item => {
          return new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler(function() {
                console.log(`Questions for persona "${item.persona}" saved successfully.`);
                resolve(); // Resolve the promise when saving is successful
              })
              .withFailureHandler(function(error) {
                console.error(`Failed to save questions for persona "${item.persona}":`, error);
                reject(error); // Reject the promise if saving fails
              })
              .saveGeneratedQuestions(item.persona, item.questions.map(q => ({
                text: q.text,
                question: q.question
              })), timestamp); // Pass the same timestamp for all personas
          });
        });

        // Wait for all save operations to complete
        Promise.all(savePromises)
          .then(() => {
            alert("All questions saved successfully!");

            // Refresh the dropdowns to include the newly added version
            populateDropdowns();

            // Refresh the data to display newly saved questions
            refreshQuestions();
          })
          .catch(error => {
            alert("Failed to save all questions. Please try again.");
            console.error("Error saving questions:", error);
          });
      }

      function refreshQuestions() {
        google.script.run.withSuccessHandler(function(savedData) {
          displayQuestions(savedData); // Display the updated questions
        }).getSavedQuestions();
      }

      function regenerateQuestions() {
        closeGeneratedQuestionsPopup();
        generateQuestions(); // Call the generateQuestions function again
      }
      
      function populateDropdowns() {
        google.script.run.withSuccessHandler(function(savedData) {
          if (!Array.isArray(savedData)) {
            console.error("Saved data is not an array:", savedData);
            savedData = []; // Default to an empty array
          }

          const personas = [...new Set(savedData.map(item => item.persona))]; // Unique personas
          const timestamps = savedData.map(item => item.timestamp);

          // Populate persona dropdown
          const personaDropdown = document.getElementById('persona-dropdown');
          personaDropdown.innerHTML = '<option value="all">All Personas</option>';
          personas.forEach(persona => {
            const option = document.createElement('option');
            option.value = persona;
            option.textContent = persona;
            personaDropdown.appendChild(option);
          });

          // Populate version dropdown
          const versionDropdown = document.getElementById('version-dropdown');
          versionDropdown.innerHTML = '<option value="all">All Versions</option>';
          timestamps.forEach(timestamp => {
            const option = document.createElement('option');
            option.value = timestamp;
            option.textContent = timestamp;
            versionDropdown.appendChild(option);
          });
        }).getSavedQuestions();
      }

      // Populate dropdowns with saved data
      google.script.run.withSuccessHandler(function(savedData) {
        populateDropdowns(savedData); // Populate both dropdowns
        // displayQuestions(savedData); // Display all questions by default
      }).getSavedQuestions();

      function filterQuestionsByToneAndType() {
        const selectedTone = document.getElementById('tone-dropdown').value;
        const selectedType = document.getElementById('type-dropdown').value;

        // Combine saved questions and currently generated questions
        google.script.run.withSuccessHandler(function(savedData) {
          const allQuestions = [...savedData, ...currentGeneratedQuestions];

          const filteredQuestions = allQuestions.map(item => {
            return {
              persona: item.persona,
              questions: item.questions.filter(q => {
                const toneMatches = q.tone === selectedTone;
                const typeMatches = selectedType === 'all' || q.assistanceLevel === selectedType;
                return toneMatches && typeMatches; // Match both tone and type
              })
            };
          }).filter(item => item.questions.length > 0); // Remove personas with no matching questions

          displayQuestions(filteredQuestions);
        }).getSavedQuestions();
      }

      // Display questions in the questions-display div
      function displayQuestions(questions) {
        const displayDiv = document.getElementById('questions-display');
        displayDiv.innerHTML = ''; // Clear previous content

        if (!questions || questions.length === 0) {
          displayDiv.innerHTML = `
            <div style="
              background-color: #f9fafb;
              border: 1px solid #e5e7eb;
              border-radius: 12px;
              padding: 16px;
              color: #6b7280;
              font-size: 14px;
              text-align: center;
            ">
              No questions available. Please select a tone and type to see results.
            </div>
          `;
          return;
        }

        questions.forEach(item => {
          item.questions.forEach((q, index) => {
            const explanationId = `exp-${q.slide}-${index}`;
            const explanation = q.reason || "No reasoning provided.";

            displayDiv.innerHTML += `
              <div class="card">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="font-size: 12px; color: #6b7280; font-weight: 500;">
                    ${q.tone}
                  </span>
                  <span style="font-size: 12px; color: #6b7280; font-weight: 500;">
                    ${q.assistanceLevel === 'low' ? 'Question' : 'Feedback'}
                  </span>
                </div>

                <p class="card-header"><strong>Slide</strong> ${q.slide}</p>
                <!-- <p class="card-body">${q.text}</p> --!>
                <p class="card-question">${q.question}</p>

                <div class="card-actions">
                  <md-outlined-button onclick="toggleExplanation('${explanationId}')">
                    View Reasoning
                  </md-outlined-button>
                </div>

                <div id="${explanationId}" class="explanation" style="display: none; margin-top: 12px; background: #f9fafb; padding: 12px; border-radius: 8px; font-size: 14px; color: #4b5563;">
                  <p>${explanation}</p>
                </div>
              </div>
            `;
          });
        });
      }

      // Function to toggle the explanation visibility
      function toggleExplanation(id) {
        const explanationDiv = document.getElementById(id);
        if (explanationDiv) {
          explanationDiv.style.display = (explanationDiv.style.display === 'none') ? 'block' : 'none';
        }
      }
    
      // Function to delete a question
      function deleteQuestion(persona, timestamp, question) {
        google.script.run
          .withSuccessHandler(() => {
            refreshQuestions();
          })
          .withFailureHandler(error => {
            console.error("Failed to delete question:", error);
            alert("Could not delete the question.");
          })
          .deleteQuestion(persona, timestamp, question);
      }

      // SETTINGS MANAGEMENT
      function saveSettings() {
        const model = 'gpt-4.1'; // Default model

        if (!apiKey) {
          alert("Please enter an API key.");
          return;
        }

        // Save the settings using Google Apps Script
        google.script.run
          .withSuccessHandler(function() {
            alert("Settings saved successfully!");
          })
          .withFailureHandler(function(error) {
            alert("Failed to save settings. Please try again.");
            console.error("Error saving settings:", error);
          })
          .saveApiKey(apiKey); // Save the API key
      }
    </script>
  </body>
</html>