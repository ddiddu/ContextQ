<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <span class="material-icons">info</span>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: #f4f6f8;
        margin: 0;
        padding: 10px;
        color: #333;
      }
      .tab-button {
        background-color: #ffffff;
        border-radius: 8px 8px 0 0;
        border: 1px solid #ddd;
        transition: background 0.2s ease;
      }
      .tab-button.active {
        background-color: #e0f2fe;
        font-weight: 600;
      }
      .tab-content {
        border: 1px solid #ccc;
        padding: 10px;
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      input, textarea {
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 8px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background-color: #3b82f6;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 10px 15px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
        width: 100%;
      }
      button:hover {
        background-color: #2563eb;
      }
      .card {
        border-radius: 12px;
        border: 1px solid #ccc;
        padding: 15px;
        background-color: #ffffff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .card:hover {
        background-color: #f9f9f9;
      }
      .card-persona {
        font-size: 16px;
        font-weight: bold;
        color: #3b82f6;
        margin-bottom: 10px;
      }
      .card-text {
        font-size: 14px;
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
      }
      .card-question {
        font-size: 14px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div class="tab-buttons">
      <div class="tab-button active" onclick="showTab('context')">Context</div>
      <div class="tab-button active" onclick="showTab('questions')">Questions</div>
      <div class="tab-button active" onclick="showTab('settings')">Settings</div>
    </div>      

    <!-- Context Tab -->
    <div id="context" class="tab-content active">
      <!-- Add the "Add New Context" button -->
      <button onclick="showAddContextPopup()">Add New Context</button>

      <!-- Popup Modal for Adding New Context -->
      <div id="add-context-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); padding: 20px; z-index: 1000;">
        <label for="persona-title">Title your persona:</label><br>
        <input type="text" id="persona-title" name="persona-title" style="width: 100%;"><br><br>
        
        <label for="presentation-purpose">Presentation purpose:</label><br>
        <input type="text" id="presentation-purpose" name="presentation-purpose" placeholder="This slide is for..." style="width: 100%;"><br><br>
        
        <label for="audience-settings">Audience settings:</label><br>
        <input type="text" id="audience-settings" name="audience-settings" placeholder="The audiences are..." style="width: 100%;"><br><br>
        
        <label for="core-instructions">Core instructions:</label><br>
        <input id="core-instructions" name="core-instructions" placeholder="The persona should..." rows="2" style="width: 100%;"><br><br>
        
        <label for="guardrails">Guardrails:</label><br>
        <input id="guardrails" name="guardrails" placeholder="The persona should not..." rows="2" style="width: 100%;"><br><br>
        
        <label for="example-questions">Example questions:</label><br>
        <input type="text" id="example-questions" name="example-questions" style="width: 100%;"><br><br>
        
        <!-- Buttons for saving or canceling -->
        <button onclick="saveContext()">Save</button>
        <button onclick="closeAddContextPopup()">Cancel</button>
      </div>

      <!-- Overlay for the popup -->
      <div id="popup-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;" onclick="closeAddContextPopup()"></div>

      <!-- <button onclick="saveContext()">Save Context</button> -->

      <!-- Section to display saved contexts -->
      <div id="saved-context" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; background-color: #f9f9f9;">
        <div id="context-display"></div>
      </div>
      <button onclick="generateQuestions()">Generate Questions</button>
    </div>

    <!-- Questions Tab -->
    <div id="questions" class="tab-content">
      <!-- Dropdown for selecting versions -->
      <label for="version-dropdown">Select Version:</label>
      <select id="version-dropdown" onchange="filterQuestionsByPersonaAndVersion()">
        <option value="all">All Versions</option>
      </select>

      <!-- Dropdown for selecting personas -->
      <label for="persona-dropdown">Select Persona:</label>
      <select id="persona-dropdown" onchange="filterQuestionsByPersonaAndVersion()">
        <option value="all">All Personas</option>
      </select>
    
      <!-- Section to display filtered questions -->
      <div id="questions-display" style="margin-top: 20px;">
        <!-- Questions will be dynamically displayed here -->
      </div>
    </div>

    <div id="loading-indicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.7); color: white; padding: 20px; border-radius: 8px; font-size: 16px; z-index: 1000;">
      Loading, please wait...
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <label for="api-key">API Key:</label><br>
      <input type="text" id="api-key" placeholder="Your OpenAI API Key" style="width: 100%;"><br><br>
    
      <label for="model">Model:</label><br>
      <select id="model" style="width: 100%;">
        <option value="gpt-4o-mini-2024-07-18">gpt-4o</option>
        <!-- <option value="gpt-3.5-turbo">gpt-3.5-turbo</option> -->
        <!-- <option value="gpt-4">gpt-4</option> -->
      </select><br><br>
    
      <button onclick="saveSettings()">Save Settings</button>
    </div>

    <script>
      function showTab(tabId) {
        const tabs = document.querySelectorAll('.tab-content');
        const buttons = document.querySelectorAll('.tab-button');

        // Hide all tabs and deactivate all buttons
        tabs.forEach(tab => {
          tab.classList.remove('active');
        });

        buttons.forEach(button => {
          button.classList.remove('active');
        });

        // Show the selected tab and activate the corresponding button
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
      }

      function highlightText(text) {
        google.script.run.highlightSlideText(text);
      }

      // Function to show the popup
      function showAddContextPopup(context = null) {
        // If a context is provided, populate the fields with its data
        if (context) {
          document.getElementById('persona-title').value = context.title || '';
          document.getElementById('presentation-purpose').value = context.purpose || '';
          document.getElementById('audience-settings').value = context.audience || '';
          document.getElementById('core-instructions').value = context.instructions || '';
          document.getElementById('guardrails').value = context.guardrails || '';
          document.getElementById('example-questions').value = context.examples || '';
        } else {
          // Clear the fields if no context is provided
          document.getElementById('persona-title').value = '';
          document.getElementById('presentation-purpose').value = '';
          document.getElementById('audience-settings').value = '';
          document.getElementById('core-instructions').value = '';
          document.getElementById('guardrails').value = '';
          document.getElementById('example-questions').value = '';
        }

        document.getElementById('add-context-popup').style.display = 'block';
        document.getElementById('popup-overlay').style.display = 'block';
      }

      // Function to close the popup
      function closeAddContextPopup() {
        document.getElementById('add-context-popup').style.display = 'none';
        document.getElementById('popup-overlay').style.display = 'none';
      }

      // Function to save the context
      function saveContext() {
        const context = {
          title: document.getElementById("persona-title").value,
          purpose: document.getElementById("presentation-purpose").value,
          audience: document.getElementById("audience-settings").value,
          instructions: document.getElementById("core-instructions").value,
          guardrails: document.getElementById("guardrails").value,
          examples: document.getElementById("example-questions").value
        };

        // Display the saved context below the form
        const contextDisplay = document.getElementById("context-display");
        const newContextHTML = `
          <div class="saved-context-item" style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #f9f9f9; cursor: pointer;">
            <p><strong>${context.title}</strong></p>
            <button onclick='showAddContextPopup(${JSON.stringify(context)})'>View/Modify</button>
          </div>
        `;
        contextDisplay.innerHTML += newContextHTML; // Append the new context

        // Clear the input fields
        document.getElementById("persona-title").value = '';
        document.getElementById("presentation-purpose").value = '';
        document.getElementById("audience-settings").value = ''; 
        document.getElementById("core-instructions").value = '';
        document.getElementById("guardrails").value = '';
        document.getElementById("example-questions").value = '';

        // Close the popup
        closeAddContextPopup();

        // Alert the user that the context has been saved
        alert("Context saved!");
      }

      // Example JSON data (this would be loaded from a file in a real scenario)
      const savedContexts = [
        {
          title: 'Google Workspace UX Research',
          purpose: "final presentation",
          audience: "senior ux researcher",
          instructions: "The persona should be a senior UX researcher with a focus on Google Workspace products.",
          guardrails: "The persona should not include any personal opinions or biases.",
          examples: "interesting to see so many ChatGPT users, especially since it seems many users are concerned about privacy, how their data is being used, etc. Did you get a sense (in the interviews, survey, or both) if these product managers' companies had paid ChatGPT licenses? Or, were the product managers using their own personal ChatGPT account to get AI assistance?"
        },
        {
          title: 'Marketing Persona',
          purpose: "Marketing strategy",
          audience: "Marketing managers",
          instructions: "The persona should focus on marketing strategies for social media.",
          guardrails: "The persona should not include outdated marketing practices.",
          examples: "What are the latest trends in social media marketing?"
        }
      ];

      // Function to load saved contexts into the display
      function loadSavedContexts() {
        const contextDisplay = document.getElementById("context-display");
        contextDisplay.innerHTML = ''; // Clear existing content

        savedContexts.forEach((context, index) => {
          const contextHTML = `
            <div class="saved-context-item" 
                style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background-color: #f9f9f9; cursor: pointer;" 
                onclick="toggleSelectPersona(${index}, this)">
              <p><strong>${context.title}</strong></p>
              <button onclick="event.stopPropagation(); showAddContextPopup(savedContexts[${index}])">View/Modify</button>
            </div>
          `;
          contextDisplay.innerHTML += contextHTML;
        });
      }

      // Array to track selected personas
      const selectedPersonas = [];

      // Function to toggle selection of a persona
      function toggleSelectPersona(index, element) {
        const selectedIndex = selectedPersonas.indexOf(index);

        if (selectedIndex > -1) {
          // If already selected, deselect it
          selectedPersonas.splice(selectedIndex, 1);
          element.style.backgroundColor = '#f9f9f9'; // Reset background color
        } else {
          // If not selected, add it to the selection
          selectedPersonas.push(index);
          element.style.backgroundColor = '#e0f2fe'; // Highlight selected item
        }
      }

      function generateQuestions() {
        console.log("Generate Questions button clicked."); // Debugging log

        if (selectedPersonas.length === 0) {
          console.error("No personas selected. Please select at least one persona.");
          alert("Please select at least one persona before generating questions.");
          return;
        }

        const selectedContexts = selectedPersonas.map(index => savedContexts[index]);
        console.log("Selected contexts:", selectedContexts);

        // Show the loading indicator
        const loadingIndicator = document.getElementById('loading-indicator');
        loadingIndicator.style.display = 'block';

        // Clear previous questions and dropdowns
        const displayDiv = document.getElementById('questions-display');
        displayDiv.innerHTML = ''; // Clear previous content

        const versionDropdown = document.getElementById('version-dropdown');
        versionDropdown.innerHTML = ''; // Clear previous versions

        const personaDropdown = document.getElementById('persona-dropdown');
        personaDropdown.innerHTML = ''; // Clear previous personas

        // Call the Apps Script function to generate questions
        google.script.run
          .withSuccessHandler(function(currentQuestions) {
            console.log("Received questions:", currentQuestions); // Log the received data

            // Hide the loading indicator
            loadingIndicator.style.display = 'none';

            if (!Array.isArray(currentQuestions)) {
              console.error("Current questions is not an array:", currentQuestions);
              currentQuestions = [];
            }

            // Get the current timestamp
            const currentTimestamp = new Date().toISOString();

            // Populate the version dropdown with all timestamps
            populateVersionDropdown();

            // Populate the version dropdown with the current timestamp
            versionDropdown.innerHTML = `<option value="${currentTimestamp}">${currentTimestamp}</option>`;
            versionDropdown.value = currentTimestamp;

            // Populate the persona dropdown
            personaDropdown.innerHTML = '<option value="all">All Personas</option>';
            personaDropdown.value = 'all';

            // Display the generated questions
            if (currentQuestions.length === 0) {
              displayDiv.innerHTML = '<p>No questions available.</p>';
              return;
            }

            currentQuestions.forEach(item => {
              if (!item.questions || !Array.isArray(item.questions)) {
                console.error("Invalid questions format for item:", item);
                return;
              }

              item.questions.forEach(q => {
                displayDiv.innerHTML += `
                  <div class="card">
                    <p class="card-persona"><strong>Persona:</strong> ${item.persona}</p>
                    <p class="card-text"><strong>Text:</strong> ${q.text}</p>
                    <p class="card-question"><strong>Question:</strong> ${q.question}</p>
                  </div>
                `;
              });
            });

            // Automatically switch to the "Questions" tab
            showTab('questions');
          })
          .withFailureHandler(function(error) {
            console.error("Error generating questions:", error); // Log any errors
            alert("Failed to generate questions. Please try again.");

            // Hide the loading indicator
            loadingIndicator.style.display = 'none';
          })
          .generateComments(selectedContexts); // Pass the selected contexts to the backend
      }

      // all the function to load saved contexts when the page loads
      document.addEventListener("DOMContentLoaded", loadSavedContexts);

      function selectContext(element) {
        // Toggle the highlight of the selected context
        if (element.style.backgroundColor === 'rgb(224, 242, 254)') {
          element.style.backgroundColor = '#f9f9f9'; // Deselect if already selected
        } else {
          element.style.backgroundColor = '#e0f2fe'; // Highlight selected item
        }
      }

      function showTab(tabId) {
        const tabs = document.querySelectorAll('.tab-content');
        const buttons = document.querySelectorAll('.tab-button');

        // Hide all tabs and deactivate all buttons
        tabs.forEach(tab => {
          tab.classList.remove('active');
        });

        buttons.forEach(button => {
          button.classList.remove('active');
        });

        // Show the selected tab and activate the corresponding button
        document.getElementById(tabId).classList.add('active');
        document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
      }

      function saveSettings() {
        const apiKey = document.getElementById("api-key").value;
        const model = document.getElementById("model").value;

        console.log("API Key:", apiKey);
        console.log("Model:", model);

        if (typeof google !== 'undefined' && google.script && google.script.run) {
          console.log("google.script.run is defined. Saving settings...");
          google.script.run
            .withSuccessHandler(() => {
              console.log("Settings saved successfully.");
              alert("Settings saved!");
            })
            .withFailureHandler((error) => {
              console.error("Error saving settings:", error);
              alert("Failed to save settings. Please try again.");
            })
            .saveApiKey(apiKey);
        } else {
          console.error("google.script.run is not defined. Are you running this in a Google Apps Script environment?");
          alert("Error: Unable to save settings. Please check your environment.");
        }
      }

      // Populate the persona dropdown
      function populatePersonaDropdown(personas) {
        const dropdown = document.getElementById('persona-dropdown');
        personas.forEach(persona => {
          const option = document.createElement('option');
          option.value = persona;
          option.textContent = persona;
          dropdown.appendChild(option);
        });
      }

      // Populate the version dropdown
      function populateVersionDropdown() {
        google.script.run
          .withSuccessHandler(function(timestamps) {
            const versionDropdown = document.getElementById('version-dropdown');
            versionDropdown.innerHTML = ''; // Clear previous versions

            // Add "All Versions" option
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All Versions';
            versionDropdown.appendChild(allOption);

            // Populate the dropdown with all timestamps
            timestamps.forEach(timestamp => {
              const option = document.createElement('option');
              option.value = timestamp;
              option.textContent = timestamp;
              versionDropdown.appendChild(option);
            });

            // Select the most recent timestamp by default
            if (timestamps.length > 0) {
              versionDropdown.value = timestamps[timestamps.length - 1];
            }
          })
          .getAllTimestamps(); // Call the backend function
      }

      function populateDropdowns() {
        google.script.run.withSuccessHandler(function(savedData) {
          if (!Array.isArray(savedData)) {
            console.error("Saved data is not an array:", savedData);
            savedData = []; // Default to an empty array
          }

          const personas = [...new Set(savedData.map(item => item.persona))]; // Unique personas
          const timestamps = savedData.map(item => item.timestamp);

          // Populate persona dropdown
          const personaDropdown = document.getElementById('persona-dropdown');
          personaDropdown.innerHTML = '<option value="all">All Personas</option>';
          personas.forEach(persona => {
            const option = document.createElement('option');
            option.value = persona;
            option.textContent = persona;
            personaDropdown.appendChild(option);
          });

          // Populate version dropdown
          const versionDropdown = document.getElementById('version-dropdown');
          versionDropdown.innerHTML = '<option value="all">All Versions</option>';
          timestamps.forEach(timestamp => {
            const option = document.createElement('option');
            option.value = timestamp;
            option.textContent = timestamp;
            versionDropdown.appendChild(option);
          });
        }).getSavedQuestions();
      }

      // Fetch saved questions and populate both dropdowns
      google.script.run.withSuccessHandler(function(savedData) {
        const personas = [...new Set(savedData.map(item => item.persona))]; // Unique personas
        const timestamps = savedData.map(item => item.timestamp);

        populatePersonaDropdown(personas);
        populateVersionDropdown(timestamps);

        displayQuestions(savedData); // Display all questions by default
      }).getSavedQuestions();

      // Filter questions based on the selected persona and version
      function filterQuestionsByPersonaAndVersion() {
        const selectedPersona = document.getElementById('persona-dropdown').value;
        const selectedVersion = document.getElementById('version-dropdown').value;

        google.script.run.withSuccessHandler(function(filteredData) {
          displayQuestions(filteredData);
        }).getFilteredQuestionsByPersonaAndVersion(selectedPersona, selectedVersion);
      }

      // Display questions in the questions-display div
      function displayQuestions(questions) {
        const displayDiv = document.getElementById('questions-display');
        displayDiv.innerHTML = ''; // Clear previous content

        if (questions.length === 0) {
          displayDiv.innerHTML = '<p>No questions available.</p>';
          return;
        }

        questions.forEach(item => {
          item.questions.forEach(q => {
            displayDiv.innerHTML += `
              <div class="card">
                <p class="card-persona"><strong>Persona:</strong> ${item.persona}</p>
                <p class="card-text"><strong>Text:</strong> ${q.text}</p>
                <p class="card-question"><strong>Question:</strong> ${q.question}</p>
                <button onclick="deleteQuestion('${item.persona}', '${item.timestamp}', '${q.question}')">Delete</button>
              </div>
            `;
          });
        });
      }
    
      // Function to delete a question
      function deleteQuestion(persona, timestamp, questionText) {
        if (!confirm("Are you sure you want to delete this question?")) {
          return; // Exit if the user cancels the confirmation
        }

        google.script.run
          .withSuccessHandler(function(success) {
            if (success) {
              alert("Question deleted successfully.");
              filterQuestionsByPersonaAndVersion(); // Refresh the displayed questions
            } else {
              alert("Failed to delete the question. Please try again.");
            }
          })
          .deleteQuestion(persona, timestamp, questionText);
      }
    </script>
  </body>
</html>